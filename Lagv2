local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local CollectionService = game:GetService("CollectionService")
local player = Players.LocalPlayer

local SWEEP_INTERVAL = 3
local BATCH_YIELD = 250

local function isCoreOrGui(obj)
	local cg = game:GetService("CoreGui")
	local pg = player and player:FindFirstChild("PlayerGui")
	if cg and obj:IsDescendantOf(cg) then return true end
	if pg and obj:IsDescendantOf(pg) then return true end
	return false
end

local function isWhitelisted(obj)
	if not obj then return false end
	if obj.GetAttribute and obj:GetAttribute("DoNotDestroy") == true then return true end
	if CollectionService:HasTag(obj, "NoClean") or CollectionService:HasTag(obj, "Keep") or CollectionService:HasTag(obj, "Protected") then return true end
	return false
end

local function inTool(obj)
	local cur = obj
	while cur and cur.Parent do
		if cur:IsA("Tool") then return true end
		cur = cur.Parent
	end
	return false
end

local function shouldDestroyEffect(inst)
	if not inst or not inst.Parent then return false end
	if isCoreOrGui(inst) then return false end
	if isWhitelisted(inst) then return false end
	if inTool(inst) then return false end
	if inst:IsA("ParticleEmitter") or inst:IsA("MeshParticleEmitter") or inst:IsA("Trail") or inst:IsA("Beam") then
		return true
	end
	return false
end

local function destroyEffect(inst)
	if not inst or not inst.Parent then return end
	pcall(function() inst:Destroy() end)
end

local function handleDescendant(obj)
	if not obj then return end
	if shouldDestroyEffect(obj) then
		destroyEffect(obj)
	end
end

local function quickSweep(container)
	local ok, list = pcall(function() return container:GetDescendants() end)
	if not ok or not list then return end
	for i = 1, #list do
		local v = list[i]
		if v then
			pcall(handleDescendant, v)
		end
		if i % BATCH_YIELD == 0 then task.wait() end
	end
end

local function attachListener(container)
	if not container then return end
	pcall(function()
		container.DescendantAdded:Connect(function(obj)
			task.defer(handleDescendant, obj)
		end)
	end)
end

task.spawn(function()
	quickSweep(Workspace)
	if workspace.CurrentCamera then quickSweep(workspace.CurrentCamera) end
	if player.Character then quickSweep(player.Character) end
end)

attachListener(Workspace)
if workspace.CurrentCamera then attachListener(workspace.CurrentCamera) end
player.CharacterAdded:Connect(function(char)
	task.defer(function() quickSweep(char) end)
	attachListener(char)
end)

task.spawn(function()
	while true do
		local start = tick()
		quickSweep(Workspace)
		if workspace.CurrentCamera then quickSweep(workspace.CurrentCamera) end
		if player.Character then quickSweep(player.Character) end
		local elapsed = tick() - start
		local waitTime = SWEEP_INTERVAL - elapsed
		if waitTime > 0 then
			task.wait(waitTime)
		else
			task.wait(0.1)
		end
	end
end)

RunService.Heartbeat:Connect(function()
	collectgarbage("step", 50)
end)
